@page "/game/tech-tree"
@inject HttpClient Http
@inject NavigationManager Nav

<div class="tech-tree @GetFactionClass()">
    <div class="tech-header">
        <h1>üî¨ Research & Technology</h1>
        <div class="research-output">
            <div class="output physics">
                <span class="icon">üî¨</span>
                <span class="value">+@_report?.PhysicsOutput/turn</span>
            </div>
            <div class="output engineering">
                <span class="icon">‚öôÔ∏è</span>
                <span class="value">+@_report?.EngineeringOutput/turn</span>
            </div>
            <div class="output society">
                <span class="icon">üìö</span>
                <span class="value">+@_report?.SocietyOutput/turn</span>
            </div>
        </div>
        <button class="btn-back" @onclick="GoBack">‚Üê Back</button>
    </div>

    @if (_loading)
    {
        <div class="loading">Analyzing research data...</div>
    }
    else
    {
        <div class="tech-content">
            <!-- Current Research Projects -->
            <div class="current-research">
                <h2>Current Research</h2>
                <div class="current-projects">
                    @foreach (var branch in new[] { ("Physics", _report?.CurrentPhysics, "physics"), 
                                                    ("Engineering", _report?.CurrentEngineering, "engineering"), 
                                                    ("Society", _report?.CurrentSociety, "society") })
                    {
                        <div class="project-card @branch.Item3">
                            <div class="branch-icon">@GetBranchIcon(branch.Item1)</div>
                            <div class="project-info">
                                <span class="branch-name">@branch.Item1</span>
                                @if (branch.Item2 != null)
                                {
                                    <span class="tech-name">@branch.Item2.Name</span>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: @branch.Item2.PercentComplete%"></div>
                                    </div>
                                    <span class="progress-text">
                                        @branch.Item2.Progress / @branch.Item2.Cost 
                                        (@branch.Item2.TurnsRemaining turns)
                                    </span>
                                }
                                else
                                {
                                    <span class="no-research">No active research</span>
                                    <button class="btn-select" @onclick="() => ShowBranchOptions(branch.Item1)">
                                        Select Research
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Tech Options by Branch -->
            <div class="tech-branches">
                @foreach (var branch in new[] { "Physics", "Engineering", "Society" })
                {
                    <div class="branch-column @branch.ToLower()">
                        <h3>@GetBranchIcon(branch) @branch</h3>
                        
                        <div class="tech-options">
                            @foreach (var tech in _availableTechs.Where(t => t.Branch.ToString() == branch))
                            {
                                <div class="tech-card @(tech.IsRare ? "rare" : "") tier-@tech.Tier"
                                     @onclick="() => SelectTech(tech)">
                                    <div class="tech-header">
                                        <span class="tech-name">@tech.Name</span>
                                        <span class="tech-tier">T@tech.Tier</span>
                                    </div>
                                    <p class="tech-desc">@tech.Description</p>
                                    <div class="tech-effects">
                                        @foreach (var effect in tech.Effects.Take(2))
                                        {
                                            <span class="effect">@FormatEffect(effect)</span>
                                        }
                                    </div>
                                    <div class="tech-cost">
                                        <span>Cost: @tech.Cost</span>
                                        <span class="turns">~@tech.TurnsToComplete(GetBranchOutput(branch)) turns</span>
                                    </div>
                                    @if (tech.IsRare)
                                    {
                                        <div class="rare-badge">‚ú® Rare</div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Researched Technologies -->
            <div class="researched-techs">
                <h2>Completed Research (@_report?.TotalResearched)</h2>
                <div class="researched-grid">
                    @if (_report?.ResearchedTechs != null)
                    {
                        @foreach (var (branch, techs) in _report.ResearchedTechs)
                        {
                            <div class="researched-branch @branch.ToLower()">
                                <h4>@GetBranchIcon(branch) @branch</h4>
                                <div class="tech-list">
                                    @foreach (var tech in techs)
                                    {
                                        <span class="completed-tech">‚úì @tech</span>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    }

    <!-- Tech Selection Modal -->
    @if (_showSelectionModal && _selectedTech != null)
    {
        <div class="modal-overlay" @onclick="CloseModal">
            <div class="modal tech-detail" @onclick:stopPropagation="true">
                <div class="modal-header @_selectedTech.Branch.ToString().ToLower()">
                    <span class="branch">@_selectedTech.Branch</span>
                    <span class="tier">Tier @_selectedTech.Tier</span>
                </div>
                
                <h2>@_selectedTech.Name</h2>
                <p class="description">@_selectedTech.Description</p>

                <div class="effects-section">
                    <h3>Effects</h3>
                    @foreach (var effect in _selectedTech.Effects)
                    {
                        <div class="effect-row">@FormatEffect(effect)</div>
                    }
                </div>

                <div class="cost-section">
                    <div class="cost-item">
                        <span>Research Cost:</span>
                        <span>@_selectedTech.Cost</span>
                    </div>
                    <div class="cost-item">
                        <span>Estimated Time:</span>
                        <span>@_selectedTech.TurnsToComplete(GetBranchOutput(_selectedTech.Branch.ToString())) turns</span>
                    </div>
                    @if (_selectedTech.CurrentProgress > 0)
                    {
                        <div class="cost-item">
                            <span>Stored Progress:</span>
                            <span>@_selectedTech.CurrentProgress</span>
                        </div>
                    }
                </div>

                <div class="modal-buttons">
                    <button class="btn-research" @onclick="StartResearch">
                        Begin Research
                    </button>
                    <button class="btn-cancel" @onclick="CloseModal">Cancel</button>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .tech-tree {
        min-height: 100vh;
        padding: 20px;
        background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
        color: white;
    }

    .tech-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding: 15px 20px;
        background: rgba(0,0,0,0.4);
        border-radius: 10px;
    }

    .tech-header h1 { margin: 0; }

    .research-output {
        display: flex;
        gap: 25px;
    }

    .output {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
    }

    .output.physics { background: rgba(52, 152, 219, 0.3); }
    .output.engineering { background: rgba(230, 126, 34, 0.3); }
    .output.society { background: rgba(46, 204, 113, 0.3); }

    .current-research {
        margin-bottom: 30px;
    }

    .current-projects {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
    }

    .project-card {
        display: flex;
        gap: 15px;
        padding: 20px;
        background: rgba(0,0,0,0.4);
        border-radius: 12px;
        border: 2px solid transparent;
    }

    .project-card.physics { border-color: rgba(52, 152, 219, 0.5); }
    .project-card.engineering { border-color: rgba(230, 126, 34, 0.5); }
    .project-card.society { border-color: rgba(46, 204, 113, 0.5); }

    .branch-icon {
        font-size: 2.5em;
    }

    .project-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .branch-name {
        color: #888;
        font-size: 0.85em;
        text-transform: uppercase;
    }

    .tech-name {
        font-weight: bold;
        font-size: 1.1em;
    }

    .progress-bar {
        height: 8px;
        background: rgba(255,255,255,0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2ecc71);
        transition: width 0.3s;
    }

    .progress-text {
        font-size: 0.85em;
        color: #888;
    }

    .no-research {
        color: #666;
        font-style: italic;
    }

    .btn-select {
        padding: 8px 15px;
        background: #3498db;
        border: none;
        border-radius: 5px;
        color: white;
        cursor: pointer;
        margin-top: 5px;
    }

    .tech-branches {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .branch-column {
        background: rgba(0,0,0,0.3);
        border-radius: 12px;
        padding: 15px;
    }

    .branch-column h3 {
        margin: 0 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid;
    }

    .branch-column.physics h3 { border-color: #3498db; }
    .branch-column.engineering h3 { border-color: #e67e22; }
    .branch-column.society h3 { border-color: #2ecc71; }

    .tech-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .tech-card {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .tech-card:hover {
        background: rgba(255,255,255,0.1);
        transform: translateX(5px);
    }

    .tech-card.rare {
        border-color: #9b59b6;
        background: rgba(155, 89, 182, 0.1);
    }

    .tech-card .tech-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding: 0;
        background: none;
    }

    .tech-card .tech-name {
        font-weight: bold;
    }

    .tech-tier {
        padding: 2px 8px;
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        font-size: 0.8em;
    }

    .tech-desc {
        font-size: 0.85em;
        color: #aaa;
        margin: 0 0 8px 0;
    }

    .tech-effects {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 8px;
    }

    .effect {
        padding: 2px 8px;
        background: rgba(46, 204, 113, 0.2);
        border-radius: 10px;
        font-size: 0.75em;
        color: #2ecc71;
    }

    .tech-cost {
        display: flex;
        justify-content: space-between;
        font-size: 0.85em;
        color: #888;
    }

    .rare-badge {
        position: absolute;
        top: -8px;
        right: 10px;
        background: #9b59b6;
        padding: 2px 10px;
        border-radius: 10px;
        font-size: 0.75em;
    }

    .researched-techs {
        background: rgba(0,0,0,0.3);
        border-radius: 12px;
        padding: 20px;
    }

    .researched-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-top: 15px;
    }

    .researched-branch h4 {
        margin: 0 0 10px 0;
    }

    .tech-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .completed-tech {
        color: #2ecc71;
        font-size: 0.9em;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal {
        background: #1a1a2e;
        border-radius: 15px;
        max-width: 500px;
        width: 90%;
        overflow: hidden;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        padding: 15px 20px;
    }

    .modal-header.physics { background: rgba(52, 152, 219, 0.3); }
    .modal-header.engineering { background: rgba(230, 126, 34, 0.3); }
    .modal-header.society { background: rgba(46, 204, 113, 0.3); }

    .modal h2 {
        margin: 0;
        padding: 0 20px;
    }

    .modal .description {
        padding: 0 20px;
        color: #aaa;
    }

    .effects-section, .cost-section {
        padding: 15px 20px;
        background: rgba(255,255,255,0.05);
        margin: 15px 20px;
        border-radius: 8px;
    }

    .effects-section h3 {
        margin: 0 0 10px 0;
        font-size: 0.9em;
        color: #888;
    }

    .effect-row {
        padding: 5px 0;
        color: #2ecc71;
    }

    .cost-item {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
    }

    .modal-buttons {
        display: flex;
        gap: 15px;
        padding: 20px;
    }

    .modal-buttons button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
    }

    .btn-research { background: #27ae60; color: white; }
    .btn-cancel { background: #7f8c8d; color: white; }
    .btn-back {
        padding: 10px 20px;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 5px;
        color: white;
        cursor: pointer;
    }

    .loading {
        text-align: center;
        padding: 50px;
        color: #888;
    }

    @@media (max-width: 1000px) {
        .current-projects, .tech-branches, .researched-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private bool _loading = true;
    private ResearchReportDisplay? _report;
    private List<TechOptionDisplay> _availableTechs = new();
    private TechOptionDisplay? _selectedTech;
    private bool _showSelectionModal = false;
    private string _factionId = "federation";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            // Mock data
            _report = new ResearchReportDisplay
            {
                PhysicsOutput = 25,
                EngineeringOutput = 30,
                SocietyOutput = 20,
                StoredPhysics = 50,
                StoredEngineering = 0,
                StoredSociety = 15,
                TotalResearched = 8,
                CurrentPhysics = new CurrentResearchDisplay
                {
                    TechId = "photon_torpedoes",
                    Name = "Photon Torpedoes",
                    Progress = 350,
                    Cost = 800,
                    TurnsRemaining = 18
                },
                CurrentEngineering = null,
                CurrentSociety = new CurrentResearchDisplay
                {
                    TechId = "cultural_diplomacy",
                    Name = "Cultural Exchange Programs",
                    Progress = 200,
                    Cost = 750,
                    TurnsRemaining = 28
                },
                ResearchedTechs = new()
                {
                    ["Physics"] = new() { "Improved Phasers", "Improved Shields", "Long Range Sensors" },
                    ["Engineering"] = new() { "Duranium Hulls", "Warp 6 Engines", "Orbital Shipyards" },
                    ["Society"] = new() { "Universal Translator", "Colonial Administration" }
                }
            };

            _availableTechs = new List<TechOptionDisplay>
            {
                // Physics
                new() { TechId = "quantum_torpedoes", Name = "Quantum Torpedoes", Description = "Zero-point energy warheads with devastating yield.", Branch = TechBranch.Physics, Tier = 3, Cost = 1500, Effects = new() { "unlock_weapon:quantum_torpedo", "weapon_damage:+20%" } },
                new() { TechId = "regenerative_shields", Name = "Regenerative Shields", Description = "Self-repairing shield matrix.", Branch = TechBranch.Physics, Tier = 2, Cost = 850, Effects = new() { "shield_regen:+5/turn" } },
                new() { TechId = "zero_point_energy", Name = "Zero-Point Energy", Description = "Extract energy from quantum vacuum.", Branch = TechBranch.Physics, Tier = 3, Cost = 1600, Effects = new() { "energy_production:+40%" }, IsRare = true },
                
                // Engineering
                new() { TechId = "warp_8", Name = "Warp 8 Engines", Description = "High-efficiency warp drives.", Branch = TechBranch.Engineering, Tier = 2, Cost = 1000, Effects = new() { "ship_speed:+30%" } },
                new() { TechId = "starbases", Name = "Starbase Construction", Description = "Build large orbital stations.", Branch = TechBranch.Engineering, Tier = 2, Cost = 1100, Effects = new() { "unlock_orbital:starbase" } },
                new() { TechId = "transwarp", Name = "Transwarp Drive", Description = "Break the warp 10 barrier.", Branch = TechBranch.Engineering, Tier = 4, Cost = 3500, Effects = new() { "ship_speed:+100%" }, IsRare = true },
                
                // Society
                new() { TechId = "genome_mapping", Name = "Genome Mapping", Description = "Advanced genetics improve population health.", Branch = TechBranch.Society, Tier = 2, Cost = 700, Effects = new() { "pop_growth:+15%" } },
                new() { TechId = "infiltration", Name = "Deep Cover Infiltration", Description = "Place agents in enemy governments.", Branch = TechBranch.Society, Tier = 2, Cost = 850, Effects = new() { "agent_skill:+20%" } },
                new() { TechId = "psionic_theory", Name = "Psionic Theory", Description = "Harness telepathic abilities.", Branch = TechBranch.Society, Tier = 3, Cost = 1600, Effects = new() { "unlock_psionic_units" }, IsRare = true }
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading research: {ex.Message}");
        }
        _loading = false;
    }

    private void GoBack() => Nav.NavigateTo("/game/galaxy");
    private string GetFactionClass() => _factionId.ToLower();

    private string GetBranchIcon(string branch) => branch switch
    {
        "Physics" => "üî¨",
        "Engineering" => "‚öôÔ∏è",
        "Society" => "üìö",
        _ => "üî¨"
    };

    private int GetBranchOutput(string branch) => branch switch
    {
        "Physics" => _report?.PhysicsOutput ?? 1,
        "Engineering" => _report?.EngineeringOutput ?? 1,
        "Society" => _report?.SocietyOutput ?? 1,
        _ => 1
    };

    private string FormatEffect(string effect)
    {
        return effect
            .Replace("_", " ")
            .Replace(":", ": ")
            .Replace("+", "+ ");
    }

    private void ShowBranchOptions(string branch)
    {
        // Scroll to branch or highlight
    }

    private void SelectTech(TechOptionDisplay tech)
    {
        _selectedTech = tech;
        _showSelectionModal = true;
    }

    private void CloseModal()
    {
        _showSelectionModal = false;
        _selectedTech = null;
    }

    private async Task StartResearch()
    {
        if (_selectedTech == null) return;
        
        // Would call API
        await Task.Delay(200);
        
        CloseModal();
        await LoadData();
    }

    // Display classes
    public enum TechBranch { Physics, Engineering, Society }

    public class ResearchReportDisplay
    {
        public int PhysicsOutput { get; set; }
        public int EngineeringOutput { get; set; }
        public int SocietyOutput { get; set; }
        public int StoredPhysics { get; set; }
        public int StoredEngineering { get; set; }
        public int StoredSociety { get; set; }
        public int TotalResearched { get; set; }
        public CurrentResearchDisplay? CurrentPhysics { get; set; }
        public CurrentResearchDisplay? CurrentEngineering { get; set; }
        public CurrentResearchDisplay? CurrentSociety { get; set; }
        public Dictionary<string, List<string>> ResearchedTechs { get; set; } = new();
    }

    public class CurrentResearchDisplay
    {
        public string TechId { get; set; } = "";
        public string Name { get; set; } = "";
        public int Progress { get; set; }
        public int Cost { get; set; }
        public int TurnsRemaining { get; set; }
        public int PercentComplete => Cost > 0 ? Progress * 100 / Cost : 0;
    }

    public class TechOptionDisplay
    {
        public string TechId { get; set; } = "";
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public TechBranch Branch { get; set; }
        public int Tier { get; set; }
        public int Cost { get; set; }
        public int CurrentProgress { get; set; }
        public List<string> Effects { get; set; } = new();
        public bool IsRare { get; set; }
        public int TurnsToComplete(int output) => output > 0 ? (int)Math.Ceiling((double)(Cost - CurrentProgress) / output) : 999;
    }
}
