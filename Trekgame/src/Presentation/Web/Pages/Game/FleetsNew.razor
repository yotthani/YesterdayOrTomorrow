@page "/game/fleets-new"
@page "/game/fleets"
@page "/game/military"
@layout StellarisLayout
@using MudBlazor
@using StarTrekGame.Web.Services
@using Blazored.LocalStorage
@inject IGameApiClient Api
@inject NavigationManager Navigation
@inject ILocalStorageService LocalStorage

<PageTitle>Fleet Command - Galactic Strategy</PageTitle>

<div class="stellaris-layout" data-theme="@(_faction?.RaceId?.ToLower() ?? "federation")">
    <header class="st-topbar">
        <div class="st-empire-badge"><div class="st-empire-flag">üåê</div><div class="st-empire-info"><span class="st-empire-name">@(_faction?.Name ?? "United Federation")</span><span class="st-empire-type">Starfleet Command</span></div></div>
        <div class="st-resources">
            <div class="st-resource"><span class="st-resource-icon">‚ö°</span><div class="st-resource-values"><span class="st-resource-current">1,250</span><span class="st-resource-income positive">+45</span></div></div>
            <div class="st-resource"><span class="st-resource-icon">üíé</span><div class="st-resource-values"><span class="st-resource-current">890</span></div></div>
            <div class="st-resource"><span class="st-resource-icon">üî©</span><div class="st-resource-values"><span class="st-resource-current">340</span></div></div>
        </div>
        <div class="st-game-controls"><div class="st-date-display"><span class="st-date-label">STARDATE</span><span class="st-date-value">24.56</span></div><button class="st-end-turn-btn">END TURN</button></div>
    </header>

    <div class="st-main">
        <aside class="st-sidebar-left">
            <nav class="st-nav">
                <a href="/game/galaxy" class="st-nav-btn"><span class="st-nav-icon">üåå</span><span class="st-nav-label">Galaxy</span></a>
                <a href="/game/research" class="st-nav-btn"><span class="st-nav-icon">üî¨</span><span class="st-nav-label">Research</span></a>
                <a href="/game/military" class="st-nav-btn active"><span class="st-nav-icon">üöÄ</span><span class="st-nav-label">Fleets</span></a>
                <a href="/game/planets" class="st-nav-btn"><span class="st-nav-icon">üè†</span><span class="st-nav-label">Planets</span></a>
            </nav>
        </aside>

        <div class="fleets-content">
            <div class="fleets-header">
                <h1>FLEET COMMAND</h1>
                <div class="fleet-capacity"><div class="capacity-bar"><div class="capacity-fill" style="width: @(_totalShips * 100 / _fleetCap)%"></div></div><span class="capacity-text">@_totalShips / @_fleetCap Naval Capacity</span></div>
                <div class="fleet-actions"><button class="st-btn">+ NEW FLEET</button></div>
            </div>

            <div class="fleets-layout">
                <div class="fleets-list-panel">
                    <div class="panel-header"><span>ALL FLEETS (@_fleets.Count)</span></div>
                    <div class="fleets-list">
                        @foreach (var fleet in _fleets)
                        {
                            <div class="fleet-row @(_selectedFleet?.Id == fleet.Id ? "selected" : "") @(fleet.IsMoving ? "moving" : "")" @onclick="() => _selectedFleet = fleet">
                                <div class="fleet-icon"><span class="icon-ship">‚ñ≤</span>@if(fleet.ShipCount > 1){<span class="ship-count">@fleet.ShipCount</span>}</div>
                                <div class="fleet-info"><span class="fleet-name">@fleet.Name</span><span class="fleet-location">üìç @fleet.CurrentSystemName</span></div>
                                <div class="fleet-stats"><div class="stat"><span class="label">PWR</span><span class="val">@fleet.CombatStrength</span></div></div>
                                <div class="fleet-status">@if(fleet.IsMoving){<span class="status moving">‚Üí @fleet.DestinationName</span>}else{<span class="status idle">IDLE</span>}</div>
                            </div>
                        }
                    </div>
                </div>

                <div class="fleet-detail-panel">
                    @if (_selectedFleet != null)
                    {
                        <div class="detail-header">
                            <div class="fleet-emblem"><span>‚öî</span></div>
                            <div class="fleet-title"><h2>@_selectedFleet.Name</h2><span class="fleet-class">@_selectedFleet.FleetType Fleet ‚Ä¢ @_selectedFleet.ShipCount Ships</span></div>
                            <div class="fleet-power"><span class="power-label">FLEET POWER</span><span class="power-value">@_selectedFleet.Power</span></div>
                        </div>
                        <div class="fleet-stats-bar">
                            <div class="stat-item"><span class="stat-icon">‚öî</span><span class="stat-name">Firepower</span><span class="stat-value">@_selectedFleet.Firepower</span></div>
                            <div class="stat-item"><span class="stat-icon">üõ°</span><span class="stat-name">Hull</span><span class="stat-value">@_selectedFleet.Hull</span></div>
                            <div class="stat-item"><span class="stat-icon">üîã</span><span class="stat-name">Shields</span><span class="stat-value">@_selectedFleet.Shields</span></div>
                            <div class="stat-item"><span class="stat-icon">‚ö°</span><span class="stat-name">Speed</span><span class="stat-value">@_selectedFleet.Speed</span></div>
                        </div>
                        <div class="ships-section">
                            <div class="section-header"><span>SHIP COMPOSITION</span><button class="st-btn sm">+ ADD</button></div>
                            <div class="ships-grid">
                                @foreach (var ship in _selectedFleet.Ships)
                                {
                                    <div class="ship-card @(ship.IsFlagship ? "flagship" : "")">
                                        <div class="ship-image"><div class="ship-sprite @GetFactionClass() @GetShipSpriteClass(ship.Class)"></div>@if(ship.IsFlagship){<span class="flagship-badge">‚òÖ</span>}</div>
                                        <div class="ship-info"><span class="ship-name">@ship.Name</span><span class="ship-class">@ship.Class</span></div>
                                        <div class="ship-health"><div class="st-progress" style="height:4px;"><div class="st-progress-fill @(ship.Health>=80?"success":ship.Health>=50?"warning":"danger")" style="width:@ship.Health%"></div></div></div>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="orders-section">
                            <div class="section-header"><span>ORDERS</span></div>
                            <div class="orders-buttons">
                                <button class="order-btn"><span class="order-icon">üéØ</span><span class="order-text">MOVE</span></button>
                                <button class="order-btn"><span class="order-icon">üîÑ</span><span class="order-text">PATROL</span></button>
                                <button class="order-btn"><span class="order-icon">üåç</span><span class="order-text">ORBIT</span></button>
                                <button class="order-btn aggressive"><span class="order-icon">‚öî</span><span class="order-text">ATTACK</span></button>
                            </div>
                        </div>
                    }
                    else { <div class="no-selection"><span class="icon">üöÄ</span><p>Select a fleet</p></div> }
                </div>
            </div>
        </div>
    </div>
    <footer class="st-bottombar"><div class="st-notifications"></div></footer>
</div>

<style>
.fleets-content{flex:1;display:flex;flex-direction:column;background:linear-gradient(180deg,#080c14 0%,#040608 100%)}
.fleets-header{padding:16px 24px;background:rgba(10,15,25,0.9);border-bottom:1px solid var(--st-border-dark);display:flex;align-items:center;gap:24px}
.fleets-header h1{font-family:var(--st-font-display);font-size:18px;color:var(--st-text-white);letter-spacing:2px;margin:0}
.fleet-capacity{flex:1}.capacity-bar{height:8px;background:rgba(0,0,0,0.4);border:1px solid var(--st-border-dark);border-radius:4px;overflow:hidden;margin-bottom:4px}
.capacity-fill{height:100%;background:linear-gradient(90deg,var(--st-accent-blue),var(--st-accent-cyan))}.capacity-text{font-size:11px;color:var(--st-text-muted)}
.fleets-layout{flex:1;display:flex;gap:16px;padding:16px;overflow:hidden}
.fleets-list-panel{width:400px;background:var(--st-gradient-panel);border:1px solid var(--st-border-dark);border-radius:8px;display:flex;flex-direction:column}
.panel-header{padding:12px 16px;background:rgba(0,0,0,0.2);border-bottom:1px solid var(--st-border-dark);font-size:12px;color:var(--st-text-muted);font-weight:600}
.fleets-list{flex:1;overflow-y:auto;padding:8px}
.fleet-row{display:flex;align-items:center;gap:12px;padding:12px;margin-bottom:6px;background:var(--st-bg-medium);border-radius:6px;cursor:pointer;border-left:3px solid transparent;transition:all 0.15s}
.fleet-row:hover{background:var(--st-bg-light)}.fleet-row.selected{background:rgba(74,158,255,0.15);border-left-color:var(--st-accent-blue)}.fleet-row.moving{border-left-color:var(--st-accent-gold)}
.fleet-icon{position:relative;width:40px;height:40px;background:var(--st-bg-darker);border-radius:6px;display:flex;align-items:center;justify-content:center}
.icon-ship{font-size:20px;color:var(--st-accent-gold)}.ship-count{position:absolute;bottom:-4px;right:-4px;background:var(--st-accent-blue);color:#fff;font-size:10px;font-weight:600;padding:2px 5px;border-radius:8px}
.fleet-info{flex:1}.fleet-name{display:block;font-size:13px;font-weight:500;color:var(--st-text-white)}.fleet-location{display:block;font-size:10px;color:var(--st-text-dim)}
.fleet-stats .stat{text-align:center}.fleet-stats .label{display:block;font-size:9px;color:var(--st-text-dim)}.fleet-stats .val{font-size:12px;color:var(--st-text-bright)}
.status{font-size:10px;padding:3px 8px;border-radius:4px}.status.idle{background:rgba(100,100,100,0.2);color:var(--st-text-dim)}.status.moving{background:rgba(255,200,68,0.2);color:var(--st-accent-gold)}
.fleet-detail-panel{flex:1;background:var(--st-gradient-panel);border:1px solid var(--st-border-dark);border-radius:8px;overflow:hidden;display:flex;flex-direction:column}
.detail-header{display:flex;align-items:center;gap:16px;padding:20px;background:linear-gradient(180deg,rgba(20,30,50,0.9) 0%,rgba(10,18,30,0.95) 100%);border-bottom:1px solid var(--st-border-medium)}
.fleet-emblem{width:56px;height:56px;background:var(--st-bg-darker);border:2px solid var(--st-accent-gold);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:28px}
.fleet-title{flex:1}.fleet-title h2{font-family:var(--st-font-display);font-size:18px;color:var(--st-text-white);margin:0}.fleet-class{font-size:11px;color:var(--st-text-dim)}
.fleet-power{text-align:right}.power-label{display:block;font-size:10px;color:var(--st-text-dim);letter-spacing:1px}.power-value{font-family:var(--st-font-display);font-size:28px;font-weight:700;color:var(--st-accent-cyan)}
.fleet-stats-bar{display:flex;padding:16px 20px;gap:24px;background:rgba(0,0,0,0.2);border-bottom:1px solid var(--st-border-dark)}
.stat-item{display:flex;align-items:center;gap:8px}.stat-item .stat-icon{font-size:18px}.stat-item .stat-name{font-size:11px;color:var(--st-text-dim)}.stat-item .stat-value{font-family:var(--st-font-display);font-size:14px;color:var(--st-text-bright)}
.ships-section,.orders-section{padding:16px 20px}.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;font-size:12px;font-weight:600;color:var(--st-text-muted);letter-spacing:1px}
.ships-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.ship-card{background:var(--st-bg-medium);border:1px solid var(--st-border-dark);border-radius:6px;padding:10px;transition:all 0.15s}.ship-card:hover{border-color:var(--st-border-light)}.ship-card.flagship{border-color:var(--st-accent-gold);background:rgba(255,200,68,0.05)}
.ship-image{position:relative;height:60px;display:flex;align-items:center;justify-content:center;margin-bottom:8px}
.ship-sprite{width:80px;height:60px;background-repeat:no-repeat;background-position:center;background-size:contain}
.ship-sprite.federation{background-image:url('/images/ships/federation/military_ships.png');background-size:2000px 1103px}
.ship-sprite.klingon{background-image:url('/images/ships/klingon/military_ships.png');background-size:2000px 1103px}
.ship-sprite.romulan{background-image:url('/images/ships/romulan/military_ships.png');background-size:2000px 1103px}
.ship-sprite.cardassian{background-image:url('/images/ships/cardassian/military_ships.png');background-size:2000px 1103px}
.ship-sprite.borg{background-image:url('/images/ships/borg/military_ships.png');background-size:2000px 1103px}
.ship-sprite.ferengi{background-image:url('/images/ships/ferengi/military_ships.png');background-size:2000px 1103px}
/* Federation ships - assuming 6 columns (~333px each), 4 rows (~275px each) */
.ship-sprite.constitution{background-position:0 0}
.ship-sprite.miranda{background-position:-333px 0}
.ship-sprite.excelsior{background-position:-666px 0}
.ship-sprite.galaxy{background-position:-999px 0}
.ship-sprite.defiant{background-position:-1332px 0}
.ship-sprite.intrepid{background-position:-1665px 0}
.ship-sprite.akira{background-position:0 -275px}
.ship-sprite.nova{background-position:-333px -275px}
.ship-sprite.oberth{background-position:-666px -275px}
.ship-sprite.nebula{background-position:-999px -275px}
/* Klingon ships */
.ship-sprite.d7{background-position:0 0}
.ship-sprite.birdofprey{background-position:-333px 0}
.ship-sprite.vorcha{background-position:-666px 0}
.ship-sprite.neghvar{background-position:-999px 0}
.flagship-badge{position:absolute;top:0;right:0;color:var(--st-accent-gold);font-size:16px}
.ship-info{text-align:center;margin-bottom:6px}.ship-name{display:block;font-size:11px;font-weight:500;color:var(--st-text-bright)}.ship-class{display:block;font-size:9px;color:var(--st-text-dim)}
.orders-buttons{display:flex;gap:10px;flex-wrap:wrap}
.order-btn{display:flex;flex-direction:column;align-items:center;padding:16px 24px;background:var(--st-gradient-button);border:1px solid var(--st-border-dark);border-radius:6px;cursor:pointer;transition:all 0.15s;min-width:80px}
.order-btn:hover{background:var(--st-gradient-button-hover);border-color:var(--st-border-light)}.order-btn.aggressive{border-color:rgba(255,68,85,0.5)}.order-btn.aggressive:hover{background:rgba(255,68,85,0.2)}
.order-icon{font-size:24px;margin-bottom:4px}.order-text{font-size:10px;font-weight:600;color:var(--st-text-muted);letter-spacing:1px}
.no-selection{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--st-text-dim);gap:16px}.no-selection .icon{font-size:48px;opacity:0.2;filter:grayscale(100%)}
</style>

@code {
    private FactionDetailDto? _faction;
    private List<FleetDetailDto> _fleets = new();
    private FleetDetailDto? _selectedFleet;
    private Guid? _factionId;
    private int _totalShips => _fleets.Sum(f => f.ShipCount);
    private int _fleetCap = 100;

    protected override async Task OnInitializedAsync()
    {
        _factionId = await LocalStorage.GetItemAsync<Guid?>("currentFactionId");
        if (_factionId.HasValue)
        {
            await LoadFleetData();
        }
        else
        {
            LoadMockData();
        }
    }

    private async Task LoadFleetData()
    {
        try
        {
            // Load faction info first
            var games = await Api.GetGamesAsync();
            var game = games.FirstOrDefault();
            if (game != null)
            {
                var gameDetail = await Api.GetGameAsync(game.Id);
                if (gameDetail != null && _factionId.HasValue)
                {
                    _faction = await Api.GetMyFactionAsync(gameDetail.Id, _factionId.Value);
                }
            }
            
            _fleets = await Api.GetFleetsAsync(_factionId!.Value);
            _selectedFleet = _fleets.FirstOrDefault();
        }
        catch
        {
            LoadMockData();
        }
    }

    private void LoadMockData()
    {
        _fleets = new List<FleetDetailDto>
        {
            new(Guid.NewGuid(), "1st Exploration Fleet", Guid.Empty, Guid.NewGuid(), "Sol", null, null, 0, "Defensive", 80, 100, 
                new() { new("Constitution", 2, 400, 300, 6), new("Miranda", 4, 200, 150, 7), new("Excelsior", 2, 500, 400, 5) }, 2400),
            new(Guid.NewGuid(), "2nd Defense Squadron", Guid.Empty, Guid.NewGuid(), "Vulcan", Guid.NewGuid(), "Andoria", 50, "Aggressive", 90, 200, 
                new() { new("Defiant", 3, 350, 250, 8), new("Akira", 2, 450, 350, 6) }, 1800),
            new(Guid.NewGuid(), "3rd Patrol Group", Guid.Empty, Guid.NewGuid(), "Alpha Centauri", null, null, 0, "Evasive", 75, 50, 
                new() { new("Nova", 3, 150, 100, 9) }, 900),
        };
        _selectedFleet = _fleets.FirstOrDefault();
    }

    private string GetFleetTypeIcon(string stance) => stance switch
    {
        "Aggressive" => "‚öî",
        "Defensive" => "üõ°",
        "Evasive" => "üí®",
        _ => "‚ñ≤"
    };
    
    private int GetTotalFirepower(FleetDetailDto fleet) => fleet.ShipGroups?.Sum(g => g.AttackPower * g.Count) ?? 0;
    private int GetTotalHull(FleetDetailDto fleet) => fleet.ShipGroups?.Sum(g => g.DefensePower * g.Count) ?? 0;
    
    private string GetFactionClass()
    {
        var raceId = _faction?.RaceId?.ToLower() ?? "federation";
        return raceId switch
        {
            "klingon" => "klingon",
            "romulan" => "romulan",
            "cardassian" => "cardassian",
            "borg" => "borg",
            "ferengi" => "ferengi",
            _ => "federation"
        };
    }
    
    private string GetShipSpriteClass(string shipClass)
    {
        // Extract base class name (e.g., "Constitution #1" -> "constitution")
        var baseName = shipClass?.Split(' ', '#')[0]?.ToLower() ?? "unknown";
        return baseName switch
        {
            // Federation
            "constitution" => "constitution",
            "miranda" => "miranda",
            "excelsior" => "excelsior",
            "galaxy" => "galaxy",
            "defiant" => "defiant",
            "intrepid" => "intrepid",
            "akira" => "akira",
            "nova" => "nova",
            "oberth" => "oberth",
            "nebula" => "nebula",
            // Klingon
            "d7" => "d7",
            "birdofprey" or "bird" => "birdofprey",
            "vorcha" or "vor'cha" => "vorcha",
            "neghvar" or "negh'var" => "neghvar",
            // Default - use first sprite
            _ => "constitution"
        };
    }
}
