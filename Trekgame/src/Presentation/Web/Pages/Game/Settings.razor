@page "/game/settings"
@using MudBlazor
@using Blazored.LocalStorage
@inject ILocalStorageService LocalStorage
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Settings - Galactic Strategy</PageTitle>

<div class="settings-wrapper">
    <header class="lcars-header">
        <a href="/game/map" class="back-link">‚Üê BACK</a>
        <h1 class="page-title">‚öô SETTINGS</h1>
    </header>

    <div class="settings-content">
        <div class="settings-panel">
            @* Display Settings *@
            <section class="settings-section">
                <h2 class="section-title">üì∫ DISPLAY</h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-name">Show Grid Lines</span>
                        <span class="setting-desc">Display grid overlay on galaxy map</span>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" @bind="_showGrid" @bind:after="SaveSettings" />
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-name">Show Fleet Labels</span>
                        <span class="setting-desc">Display fleet names on map</span>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" @bind="_showFleetLabels" @bind:after="SaveSettings" />
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-name">Show Minimap</span>
                        <span class="setting-desc">Display minimap on galaxy view</span>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" @bind="_showMinimap" @bind:after="SaveSettings" />
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-name">Animation Speed</span>
                        <span class="setting-desc">Speed of UI animations</span>
                    </div>
                    <select class="setting-select" @bind="_animationSpeed" @bind:after="SaveSettings">
                        <option value="slow">Slow</option>
                        <option value="normal">Normal</option>
                        <option value="fast">Fast</option>
                        <option value="instant">Instant</option>
                    </select>
                </div>
            </section>

            @* Sound Settings *@
            <section class="settings-section">
                <h2 class="section-title">üîä AUDIO</h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-name">Master Volume</span>
                        <span class="setting-desc">Overall audio volume</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" @bind="_masterVolume" @bind:after="SaveSettings" class="slider" />
                        <span class="slider-value">@_masterVolume%</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-name">Music Volume</span>
                        <span class="setting-desc">Background music volume</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" @bind="_musicVolume" @bind:after="SaveSettings" class="slider" />
                        <span class="slider-value">@_musicVolume%</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-name">SFX Volume</span>
                        <span class="setting-desc">Sound effects volume</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" @bind="_sfxVolume" @bind:after="SaveSettings" class="slider" />
                        <span class="slider-value">@_sfxVolume%</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-name">Notifications</span>
                        <span class="setting-desc">Audio notifications for events</span>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" @bind="_enableNotifications" @bind:after="SaveSettings" />
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </section>

            @* Gameplay Settings *@
            <section class="settings-section">
                <h2 class="section-title">üéÆ GAMEPLAY</h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-name">Auto-End Turn</span>
                        <span class="setting-desc">Automatically end turn when no orders pending</span>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" @bind="_autoEndTurn" @bind:after="SaveSettings" />
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-name">Confirm Combat</span>
                        <span class="setting-desc">Ask for confirmation before entering combat</span>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" @bind="_confirmCombat" @bind:after="SaveSettings" />
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-name">Combat Speed</span>
                        <span class="setting-desc">Speed of combat animations</span>
                    </div>
                    <select class="setting-select" @bind="_combatSpeed" @bind:after="SaveSettings">
                        <option value="detailed">Detailed</option>
                        <option value="normal">Normal</option>
                        <option value="fast">Fast</option>
                        <option value="instant">Instant</option>
                    </select>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-name">Tooltip Delay</span>
                        <span class="setting-desc">Delay before showing tooltips (ms)</span>
                    </div>
                    <select class="setting-select" @bind="_tooltipDelay" @bind:after="SaveSettings">
                        <option value="0">Instant</option>
                        <option value="200">200ms</option>
                        <option value="500">500ms</option>
                        <option value="1000">1s</option>
                    </select>
                </div>
            </section>

            @* Keyboard Shortcuts *@
            <section class="settings-section">
                <h2 class="section-title">‚å® KEYBOARD SHORTCUTS</h2>
                <div class="shortcuts-grid">
                    <div class="shortcut-item">
                        <span class="shortcut-key">M</span>
                        <span class="shortcut-action">Galaxy Map</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">F</span>
                        <span class="shortcut-action">Fleets</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">C</span>
                        <span class="shortcut-action">Colonies</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">R</span>
                        <span class="shortcut-action">Research</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">D</span>
                        <span class="shortcut-action">Diplomacy</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">O</span>
                        <span class="shortcut-action">Overview</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Enter</span>
                        <span class="shortcut-action">End Turn</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Esc</span>
                        <span class="shortcut-action">Close/Back</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">+/-</span>
                        <span class="shortcut-action">Zoom In/Out</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Space</span>
                        <span class="shortcut-action">Center Map</span>
                    </div>
                </div>
            </section>

            @* Actions *@
            <section class="settings-section">
                <h2 class="section-title">‚ö° ACTIONS</h2>
                <div class="actions-grid">
                    <button class="action-btn" @onclick="ResetSettings">
                        <span class="action-icon">üîÑ</span>
                        <span class="action-text">Reset to Defaults</span>
                    </button>
                    <button class="action-btn danger" @onclick="ClearData">
                        <span class="action-icon">üóë</span>
                        <span class="action-text">Clear Local Data</span>
                    </button>
                </div>
            </section>
        </div>
    </div>
</div>

<style>
    .settings-wrapper { min-height: 100vh; background: linear-gradient(135deg, #000010 0%, #0a0a20 100%); }
    
    .lcars-header { height: 60px; background: linear-gradient(180deg, #1a1a2e 0%, #0a0a18 100%); border-bottom: 3px solid #ff9900; display: flex; align-items: center; padding: 0 24px; gap: 24px; }
    .back-link { color: #ff9900; text-decoration: none; font-weight: 600; padding: 8px 16px; border: 1px solid #ff9900; border-radius: 6px; }
    .back-link:hover { background: #ff9900; color: #000; }
    .page-title { color: #ffcc00; font-size: 20px; font-weight: 700; letter-spacing: 4px; margin: 0; }

    .settings-content { max-width: 800px; margin: 0 auto; padding: 32px 24px; }
    
    .settings-panel { background: rgba(10, 10, 30, 0.8); border: 1px solid #334; border-radius: 16px; }
    
    .settings-section { padding: 24px; border-bottom: 1px solid #334; }
    .settings-section:last-child { border-bottom: none; }
    
    .section-title { color: #ffcc00; font-size: 14px; letter-spacing: 2px; margin: 0 0 20px 0; padding-bottom: 8px; border-bottom: 1px solid #445; }
    
    .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(100, 100, 150, 0.2); }
    .setting-item:last-child { border-bottom: none; }
    
    .setting-info { flex: 1; }
    .setting-name { display: block; color: #99ccff; font-weight: 600; font-size: 14px; }
    .setting-desc { display: block; color: #666; font-size: 12px; margin-top: 4px; }
    
    /* Toggle Switch */
    .toggle { position: relative; display: inline-block; width: 50px; height: 26px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #333; border-radius: 26px; transition: 0.3s; }
    .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: #888; border-radius: 50%; transition: 0.3s; }
    .toggle input:checked + .toggle-slider { background: #ff9900; }
    .toggle input:checked + .toggle-slider:before { transform: translateX(24px); background: #fff; }
    
    /* Select */
    .setting-select { background: #1a1a2e; border: 1px solid #445; color: #99ccff; padding: 8px 16px; border-radius: 6px; font-size: 13px; min-width: 120px; }
    .setting-select:focus { outline: none; border-color: #ff9900; }
    
    /* Slider */
    .slider-container { display: flex; align-items: center; gap: 12px; }
    .slider { width: 150px; height: 6px; border-radius: 3px; background: #333; outline: none; -webkit-appearance: none; }
    .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #ff9900; cursor: pointer; }
    .slider-value { color: #99ccff; font-size: 13px; min-width: 45px; text-align: right; }
    
    /* Shortcuts Grid */
    .shortcuts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .shortcut-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(30, 30, 60, 0.5); border-radius: 8px; }
    .shortcut-key { background: #334; color: #ffcc00; padding: 4px 10px; border-radius: 4px; font-family: monospace; font-size: 12px; min-width: 50px; text-align: center; }
    .shortcut-action { color: #99ccff; font-size: 13px; }
    
    /* Actions */
    .actions-grid { display: flex; gap: 16px; }
    .action-btn { display: flex; align-items: center; gap: 10px; background: rgba(40, 40, 80, 0.5); border: 2px solid #445; border-radius: 10px; padding: 14px 20px; cursor: pointer; transition: all 0.2s; }
    .action-btn:hover { border-color: #ff9900; transform: translateY(-2px); }
    .action-btn.danger { border-color: #664444; }
    .action-btn.danger:hover { border-color: #ff4444; background: rgba(255, 68, 68, 0.1); }
    .action-icon { font-size: 20px; }
    .action-text { color: #99ccff; font-weight: 600; }
    .action-btn.danger .action-text { color: #ff8888; }
</style>

@code {
    // Display Settings
    private bool _showGrid = true;
    private bool _showFleetLabels = true;
    private bool _showMinimap = true;
    private string _animationSpeed = "normal";
    
    // Audio Settings
    private int _masterVolume = 80;
    private int _musicVolume = 60;
    private int _sfxVolume = 80;
    private bool _enableNotifications = true;
    
    // Gameplay Settings
    private bool _autoEndTurn = false;
    private bool _confirmCombat = true;
    private string _combatSpeed = "normal";
    private string _tooltipDelay = "200";

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        try
        {
            _showGrid = await LocalStorage.GetItemAsync<bool?>("setting_showGrid") ?? true;
            _showFleetLabels = await LocalStorage.GetItemAsync<bool?>("setting_showFleetLabels") ?? true;
            _showMinimap = await LocalStorage.GetItemAsync<bool?>("setting_showMinimap") ?? true;
            _animationSpeed = await LocalStorage.GetItemAsync<string>("setting_animationSpeed") ?? "normal";
            
            _masterVolume = await LocalStorage.GetItemAsync<int?>("setting_masterVolume") ?? 80;
            _musicVolume = await LocalStorage.GetItemAsync<int?>("setting_musicVolume") ?? 60;
            _sfxVolume = await LocalStorage.GetItemAsync<int?>("setting_sfxVolume") ?? 80;
            _enableNotifications = await LocalStorage.GetItemAsync<bool?>("setting_notifications") ?? true;
            
            _autoEndTurn = await LocalStorage.GetItemAsync<bool?>("setting_autoEndTurn") ?? false;
            _confirmCombat = await LocalStorage.GetItemAsync<bool?>("setting_confirmCombat") ?? true;
            _combatSpeed = await LocalStorage.GetItemAsync<string>("setting_combatSpeed") ?? "normal";
            _tooltipDelay = await LocalStorage.GetItemAsync<string>("setting_tooltipDelay") ?? "200";
        }
        catch { /* Use defaults */ }
    }

    private async Task SaveSettings()
    {
        await LocalStorage.SetItemAsync("setting_showGrid", _showGrid);
        await LocalStorage.SetItemAsync("setting_showFleetLabels", _showFleetLabels);
        await LocalStorage.SetItemAsync("setting_showMinimap", _showMinimap);
        await LocalStorage.SetItemAsync("setting_animationSpeed", _animationSpeed);
        
        await LocalStorage.SetItemAsync("setting_masterVolume", _masterVolume);
        await LocalStorage.SetItemAsync("setting_musicVolume", _musicVolume);
        await LocalStorage.SetItemAsync("setting_sfxVolume", _sfxVolume);
        await LocalStorage.SetItemAsync("setting_notifications", _enableNotifications);
        
        await LocalStorage.SetItemAsync("setting_autoEndTurn", _autoEndTurn);
        await LocalStorage.SetItemAsync("setting_confirmCombat", _confirmCombat);
        await LocalStorage.SetItemAsync("setting_combatSpeed", _combatSpeed);
        await LocalStorage.SetItemAsync("setting_tooltipDelay", _tooltipDelay);
    }

    private async Task ResetSettings()
    {
        _showGrid = true;
        _showFleetLabels = true;
        _showMinimap = true;
        _animationSpeed = "normal";
        _masterVolume = 80;
        _musicVolume = 60;
        _sfxVolume = 80;
        _enableNotifications = true;
        _autoEndTurn = false;
        _confirmCombat = true;
        _combatSpeed = "normal";
        _tooltipDelay = "200";
        
        await SaveSettings();
        Snackbar.Add("Settings reset to defaults", Severity.Success);
    }

    private async Task ClearData()
    {
        await LocalStorage.ClearAsync();
        Snackbar.Add("Local data cleared", Severity.Warning);
        Navigation.NavigateTo("/", forceLoad: true);
    }
}
