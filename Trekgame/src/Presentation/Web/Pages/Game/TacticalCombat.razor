@page "/game/tactical"
@page "/game/tactical-view"
@using MudBlazor
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Tactical Combat - Galactic Strategy</PageTitle>

<div class="combat-wrapper">
    @* Top Bar - Battle Info *@
    <header class="combat-header">
        <div class="battle-info">
            <span class="battle-location">üìç Battle of @_battleLocation</span>
            <span class="battle-turn">Turn @_battleTurn</span>
        </div>
        <h1>‚öîÔ∏è TACTICAL COMBAT</h1>
        <div class="header-actions">
            <button class="action-btn retreat" @onclick="AttemptRetreat" disabled="@(!_canRetreat)">
                üö™ RETREAT
            </button>
            <button class="action-btn end-phase" @onclick="EndPhase">
                ‚è≠Ô∏è END PHASE
            </button>
            <button class="action-btn auto" @onclick="ToggleAutoBattle">
                @(_autoBattle ? "‚è∏Ô∏è PAUSE" : "‚ñ∂Ô∏è AUTO")
            </button>
        </div>
    </header>

    <div class="combat-content">
        @* Left Panel - Your Fleet *@
        <aside class="fleet-panel friendly">
            <div class="panel-header friendly">
                <span class="faction-icon">üåê</span>
                <h3>YOUR FLEET</h3>
                <span class="fleet-strength">Power: @_friendlyPower</span>
            </div>
            <div class="ships-list">
                @foreach (var ship in _friendlyShips)
                {
                    var isSelected = ship.Id == _selectedShipId;
                    <div class="ship-card @(isSelected ? "selected" : "") @(ship.IsDestroyed ? "destroyed" : "")"
                         @onclick="() => SelectShip(ship)">
                        <div class="ship-icon @ship.Class.ToLower()">@GetShipIcon(ship.Class)</div>
                        <div class="ship-info">
                            <span class="ship-name">@ship.Name</span>
                            <span class="ship-class">@ship.Class</span>
                        </div>
                        <div class="ship-bars">
                            <div class="bar-row">
                                <span class="bar-label">Hull</span>
                                <div class="bar hull">
                                    <div class="bar-fill" style="width: @ship.HullPercent%"></div>
                                </div>
                                <span class="bar-value">@ship.Hull/@ship.MaxHull</span>
                            </div>
                            <div class="bar-row">
                                <span class="bar-label">Shield</span>
                                <div class="bar shield">
                                    <div class="bar-fill" style="width: @ship.ShieldPercent%"></div>
                                </div>
                                <span class="bar-value">@ship.Shield/@ship.MaxShield</span>
                            </div>
                        </div>
                        @if (ship.IsDestroyed)
                        {
                            <div class="destroyed-overlay">DESTROYED</div>
                        }
                    </div>
                }
            </div>
            <div class="formation-controls">
                <h4>FORMATION</h4>
                <div class="formation-buttons">
                    @foreach (var formation in _formations)
                    {
                        <button class="formation-btn @(_currentFormation == formation.Id ? "active" : "")"
                                @onclick="() => SetFormation(formation.Id)"
                                title="@formation.Description">
                            <span class="form-icon">@formation.Icon</span>
                            <span class="form-name">@formation.Name</span>
                        </button>
                    }
                </div>
            </div>
        </aside>

        @* Center - Tactical Map *@
        <main class="tactical-map">
            <svg viewBox="-400 -300 800 600" class="battle-svg">
                <defs>
                    <radialGradient id="space-bg">
                        <stop offset="0%" stop-color="#0a0e18"/>
                        <stop offset="100%" stop-color="#040608"/>
                    </radialGradient>
                    <radialGradient id="friendly-glow">
                        <stop offset="0%" stop-color="rgba(59, 130, 246, 0.4)"/>
                        <stop offset="100%" stop-color="transparent"/>
                    </radialGradient>
                    <radialGradient id="enemy-glow">
                        <stop offset="0%" stop-color="rgba(239, 68, 68, 0.4)"/>
                        <stop offset="100%" stop-color="transparent"/>
                    </radialGradient>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="3"/>
                        <feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                    <marker id="weapon-arrow" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                        <polygon points="0 0, 6 3, 0 6" fill="#f59e0b"/>
                    </marker>
                </defs>

                @* Background *@
                <rect x="-400" y="-300" width="800" height="600" fill="url(#space-bg)"/>
                
                @* Stars *@
                @for (int i = 0; i < 50; i++)
                {
                    var x = _random.Next(-380, 380);
                    var y = _random.Next(-280, 280);
                    var size = _random.Next(1, 3);
                    <circle cx="@x" cy="@y" r="@size" fill="rgba(255,255,255,@(_random.NextDouble() * 0.5 + 0.2))"/>
                }

                @* Center Line *@
                <line x1="0" y1="-300" x2="0" y2="300" stroke="rgba(100,100,150,0.2)" stroke-dasharray="10,5"/>

                @* Weapon Fire Lines *@
                @foreach (var fire in _weaponFire)
                {
                    <line x1="@fire.FromX" y1="@fire.FromY" x2="@fire.ToX" y2="@fire.ToY"
                          stroke="@fire.Color" stroke-width="2" opacity="0.8"
                          marker-end="url(#weapon-arrow)">
                        <animate attributeName="opacity" values="1;0" dur="0.5s" fill="freeze"/>
                    </line>
                }

                @* Friendly Ships *@
                @foreach (var ship in _friendlyShips.Where(s => !s.IsDestroyed))
                {
                    var pos = GetShipPosition(ship, true);
                    var isSelected = ship.Id == _selectedShipId;
                    <g transform="translate(@pos.X, @pos.Y)" class="ship-marker friendly @(isSelected ? "selected" : "")"
                       @onclick="() => SelectShip(ship)" style="cursor: pointer;">
                        <ellipse cx="0" cy="0" rx="30" ry="30" fill="url(#friendly-glow)"/>
                        <polygon points="-15,-10 15,0 -15,10" fill="#3b82f6" filter="url(#glow)"/>
                        @if (isSelected)
                        {
                            <circle cx="0" cy="0" r="25" fill="none" stroke="#fbbf24" stroke-width="2" stroke-dasharray="5,3">
                                <animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="3s" repeatCount="indefinite"/>
                            </circle>
                        }
                        <text x="0" y="35" text-anchor="middle" fill="#60a5fa" font-size="9">@ship.Name</text>
                    </g>
                }

                @* Enemy Ships *@
                @foreach (var ship in _enemyShips.Where(s => !s.IsDestroyed))
                {
                    var pos = GetShipPosition(ship, false);
                    var isTarget = ship.Id == _targetShipId;
                    <g transform="translate(@pos.X, @pos.Y)" class="ship-marker enemy @(isTarget ? "targeted" : "")"
                       @onclick="() => TargetShip(ship)" style="cursor: pointer;">
                        <ellipse cx="0" cy="0" rx="30" ry="30" fill="url(#enemy-glow)"/>
                        <polygon points="15,-10 -15,0 15,10" fill="#ef4444" filter="url(#glow)"/>
                        @if (isTarget)
                        {
                            <circle cx="0" cy="0" r="25" fill="none" stroke="#f87171" stroke-width="2">
                                <animate attributeName="r" values="20;30;20" dur="1s" repeatCount="indefinite"/>
                            </circle>
                            <line x1="-35" y1="0" x2="-20" y2="0" stroke="#f87171" stroke-width="2"/>
                            <line x1="20" y1="0" x2="35" y2="0" stroke="#f87171" stroke-width="2"/>
                            <line x1="0" y1="-35" x2="0" y2="-20" stroke="#f87171" stroke-width="2"/>
                            <line x1="0" y1="20" x2="0" y2="35" stroke="#f87171" stroke-width="2"/>
                        }
                        <text x="0" y="35" text-anchor="middle" fill="#f87171" font-size="9">@ship.Name</text>
                    </g>
                }

                @* Destroyed Ships (debris) *@
                @foreach (var ship in _friendlyShips.Concat(_enemyShips).Where(s => s.IsDestroyed))
                {
                    var pos = GetShipPosition(ship, _friendlyShips.Contains(ship));
                    <g transform="translate(@pos.X, @pos.Y)" opacity="0.4">
                        <circle cx="-5" cy="-5" r="3" fill="#666"/>
                        <circle cx="5" cy="3" r="2" fill="#555"/>
                        <circle cx="-3" cy="7" r="2" fill="#666"/>
                        <text x="0" y="25" text-anchor="middle" fill="#666" font-size="8">@ship.Name (Destroyed)</text>
                    </g>
                }
            </svg>

            @* Battle Log *@
            <div class="battle-log">
                <div class="log-header">BATTLE LOG</div>
                <div class="log-content">
                    @foreach (var entry in _battleLog.TakeLast(8))
                    {
                        <div class="log-entry @entry.Type">
                            <span class="log-time">[@entry.Turn]</span>
                            <span class="log-text">@entry.Message</span>
                        </div>
                    }
                </div>
            </div>
        </main>

        @* Right Panel - Enemy Fleet & Actions *@
        <aside class="fleet-panel enemy">
            <div class="panel-header enemy">
                <span class="faction-icon">üëΩ</span>
                <h3>@_enemyFaction</h3>
                <span class="fleet-strength">Power: @_enemyPower</span>
            </div>
            <div class="ships-list">
                @foreach (var ship in _enemyShips)
                {
                    var isTarget = ship.Id == _targetShipId;
                    <div class="ship-card enemy @(isTarget ? "targeted" : "") @(ship.IsDestroyed ? "destroyed" : "")"
                         @onclick="() => TargetShip(ship)">
                        <div class="ship-icon @ship.Class.ToLower()">@GetShipIcon(ship.Class)</div>
                        <div class="ship-info">
                            <span class="ship-name">@ship.Name</span>
                            <span class="ship-class">@ship.Class</span>
                        </div>
                        <div class="ship-bars">
                            <div class="bar-row">
                                <span class="bar-label">Hull</span>
                                <div class="bar hull">
                                    <div class="bar-fill" style="width: @ship.HullPercent%"></div>
                                </div>
                            </div>
                            <div class="bar-row">
                                <span class="bar-label">Shield</span>
                                <div class="bar shield">
                                    <div class="bar-fill" style="width: @ship.ShieldPercent%"></div>
                                </div>
                            </div>
                        </div>
                        @if (ship.IsDestroyed)
                        {
                            <div class="destroyed-overlay">DESTROYED</div>
                        }
                    </div>
                }
            </div>

            @* Combat Actions *@
            <div class="combat-actions">
                <h4>COMBAT ORDERS</h4>
                @if (_selectedShip != null && _targetShip != null)
                {
                    <div class="action-target">
                        <span class="attacker">@_selectedShip.Name</span>
                        <span class="arrow">‚Üí</span>
                        <span class="target">@_targetShip.Name</span>
                    </div>
                    <div class="action-buttons">
                        <button class="combat-btn attack" @onclick="ExecuteAttack">
                            <span class="btn-icon">üî´</span>
                            <span class="btn-text">FIRE WEAPONS</span>
                            <span class="btn-damage">~@CalculateDamage() dmg</span>
                        </button>
                        <button class="combat-btn torpedo" @onclick="FireTorpedo" disabled="@(!_selectedShip.HasTorpedoes)">
                            <span class="btn-icon">üí•</span>
                            <span class="btn-text">TORPEDO</span>
                            <span class="btn-damage">~@(_selectedShip.TorpedoDamage) dmg</span>
                        </button>
                        <button class="combat-btn special" @onclick="UseSpecial" disabled="@(!_selectedShip.HasSpecial)">
                            <span class="btn-icon">‚ö°</span>
                            <span class="btn-text">@(_selectedShip.SpecialAbility ?? "SPECIAL")</span>
                        </button>
                    </div>
                }
                else
                {
                    <div class="no-target">
                        <p>Select one of your ships and an enemy target to issue orders.</p>
                    </div>
                }

                <div class="battle-odds">
                    <h4>BATTLE ANALYSIS</h4>
                    <div class="odds-bar">
                        <div class="odds-friendly" style="width: @_winChance%"></div>
                        <div class="odds-enemy" style="width: @(100 - _winChance)%"></div>
                    </div>
                    <div class="odds-labels">
                        <span class="friendly">Victory: @_winChance%</span>
                        <span class="enemy">Defeat: @(100 - _winChance)%</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>

<style>
.combat-wrapper {
    position: fixed;
    inset: 0;
    background: #040608;
    display: flex;
    flex-direction: column;
    font-family: 'Segoe UI', system-ui, sans-serif;
    color: #c8d4e8;
}

.combat-header {
    height: 60px;
    background: linear-gradient(180deg, rgba(20, 15, 25, 0.98) 0%, rgba(10, 8, 15, 0.99) 100%);
    border-bottom: 1px solid rgba(239, 68, 68, 0.4);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
}

.battle-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.battle-location { font-size: 12px; color: rgba(200, 212, 232, 0.7); }
.battle-turn { font-size: 10px; color: rgba(251, 191, 36, 0.8); }

.combat-header h1 {
    font-size: 18px;
    color: #ef4444;
    letter-spacing: 2px;
    margin: 0;
}

.header-actions { display: flex; gap: 10px; }

.action-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.action-btn.retreat {
    background: rgba(234, 179, 8, 0.2);
    border: 1px solid rgba(234, 179, 8, 0.4);
    color: #fbbf24;
}

.action-btn.retreat:hover:not(:disabled) { background: rgba(234, 179, 8, 0.4); }
.action-btn.retreat:disabled { opacity: 0.5; cursor: not-allowed; }

.action-btn.end-phase {
    background: rgba(59, 130, 246, 0.3);
    color: #60a5fa;
}

.action-btn.end-phase:hover { background: rgba(59, 130, 246, 0.5); }

.action-btn.auto {
    background: rgba(16, 185, 129, 0.3);
    color: #34d399;
}

.action-btn.auto:hover { background: rgba(16, 185, 129, 0.5); }

.combat-content {
    flex: 1;
    display: grid;
    grid-template-columns: 280px 1fr 300px;
    overflow: hidden;
}

/* Fleet Panels */
.fleet-panel {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.fleet-panel.friendly { background: linear-gradient(180deg, rgba(15, 25, 45, 0.95) 0%, rgba(8, 15, 30, 0.98) 100%); border-right: 1px solid rgba(59, 130, 246, 0.3); }
.fleet-panel.enemy { background: linear-gradient(180deg, rgba(35, 15, 20, 0.95) 0%, rgba(20, 8, 12, 0.98) 100%); border-left: 1px solid rgba(239, 68, 68, 0.3); }

.panel-header {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.panel-header.friendly { background: linear-gradient(90deg, rgba(59, 130, 246, 0.4) 0%, rgba(37, 99, 235, 0.2) 100%); border-bottom: 1px solid rgba(59, 130, 246, 0.3); }
.panel-header.enemy { background: linear-gradient(90deg, rgba(239, 68, 68, 0.4) 0%, rgba(185, 28, 28, 0.2) 100%); border-bottom: 1px solid rgba(239, 68, 68, 0.3); }

.faction-icon { font-size: 20px; }

.panel-header h3 {
    flex: 1;
    margin: 0;
    font-size: 12px;
    letter-spacing: 1px;
}

.fleet-panel.friendly h3 { color: #60a5fa; }
.fleet-panel.enemy h3 { color: #f87171; }

.fleet-strength { font-size: 11px; color: rgba(200, 212, 232, 0.6); }

.ships-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.ship-card {
    background: rgba(20, 25, 40, 0.6);
    border: 1px solid rgba(60, 80, 120, 0.3);
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.ship-card:hover { border-color: rgba(100, 140, 200, 0.5); }
.ship-card.selected { border-color: #fbbf24; box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }
.ship-card.targeted { border-color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.3); }
.ship-card.destroyed { opacity: 0.5; }

.ship-icon {
    float: left;
    width: 36px;
    height: 36px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    margin-right: 10px;
}

.ship-icon.scout { background: rgba(139, 92, 246, 0.3); }
.ship-icon.escort { background: rgba(59, 130, 246, 0.3); }
.ship-icon.cruiser { background: rgba(16, 185, 129, 0.3); }
.ship-icon.battleship { background: rgba(239, 68, 68, 0.3); }

.ship-info { margin-bottom: 8px; }
.ship-name { display: block; font-size: 12px; color: #fff; font-weight: 500; }
.ship-class { font-size: 10px; color: rgba(200, 212, 232, 0.6); }

.ship-bars { clear: both; }

.bar-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
}

.bar-label { font-size: 8px; color: rgba(200, 212, 232, 0.5); width: 35px; }

.bar {
    flex: 1;
    height: 6px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 3px;
    overflow: hidden;
}

.bar.hull .bar-fill { background: linear-gradient(90deg, #10b981, #34d399); }
.bar.shield .bar-fill { background: linear-gradient(90deg, #3b82f6, #60a5fa); }

.bar-value { font-size: 9px; color: rgba(200, 212, 232, 0.6); width: 45px; text-align: right; }

.destroyed-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #f87171;
    font-weight: 700;
    font-size: 12px;
    letter-spacing: 2px;
    border-radius: 6px;
}

/* Formation Controls */
.formation-controls {
    padding: 12px;
    border-top: 1px solid rgba(59, 130, 246, 0.2);
}

.formation-controls h4 {
    margin: 0 0 10px;
    font-size: 10px;
    color: rgba(96, 165, 250, 0.6);
    letter-spacing: 1px;
}

.formation-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 6px;
}

.formation-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px;
    background: rgba(25, 35, 55, 0.5);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 4px;
    color: rgba(150, 180, 220, 0.7);
    font-size: 9px;
    cursor: pointer;
    transition: all 0.2s;
}

.formation-btn:hover { border-color: rgba(96, 165, 250, 0.5); }
.formation-btn.active { border-color: #60a5fa; background: rgba(59, 130, 246, 0.2); color: #fff; }

.form-icon { font-size: 16px; margin-bottom: 4px; }

/* Tactical Map */
.tactical-map {
    display: flex;
    flex-direction: column;
    background: #040608;
    position: relative;
}

.battle-svg {
    flex: 1;
    min-height: 0;
}

.ship-marker { cursor: pointer; }
.ship-marker:hover polygon { filter: brightness(1.3); }

/* Battle Log */
.battle-log {
    height: 120px;
    background: rgba(10, 15, 25, 0.9);
    border-top: 1px solid rgba(100, 100, 150, 0.3);
}

.log-header {
    padding: 6px 12px;
    background: rgba(60, 70, 100, 0.3);
    font-size: 10px;
    color: rgba(200, 212, 232, 0.6);
    letter-spacing: 1px;
}

.log-content {
    padding: 8px 12px;
    overflow-y: auto;
    max-height: 90px;
}

.log-entry {
    font-size: 11px;
    padding: 3px 0;
    border-bottom: 1px solid rgba(60, 70, 100, 0.2);
}

.log-entry.damage { color: #f87171; }
.log-entry.hit { color: #fbbf24; }
.log-entry.miss { color: rgba(200, 212, 232, 0.5); }
.log-entry.destroyed { color: #ef4444; font-weight: 600; }
.log-entry.friendly { color: #60a5fa; }

.log-time { color: rgba(200, 212, 232, 0.4); margin-right: 8px; }

/* Combat Actions */
.combat-actions {
    padding: 12px;
    border-top: 1px solid rgba(239, 68, 68, 0.2);
}

.combat-actions h4 {
    margin: 0 0 10px;
    font-size: 10px;
    color: rgba(248, 113, 113, 0.6);
    letter-spacing: 1px;
}

.action-target {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 10px;
    background: rgba(30, 20, 25, 0.6);
    border-radius: 6px;
    margin-bottom: 12px;
    font-size: 12px;
}

.attacker { color: #60a5fa; }
.arrow { color: rgba(200, 212, 232, 0.4); }
.target { color: #f87171; }

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.combat-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.combat-btn.attack {
    background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
    color: #fff;
}

.combat-btn.attack:hover { background: linear-gradient(180deg, #f87171 0%, #ef4444 100%); }

.combat-btn.torpedo {
    background: rgba(245, 158, 11, 0.3);
    border: 1px solid rgba(245, 158, 11, 0.5);
    color: #fbbf24;
}

.combat-btn.torpedo:hover:not(:disabled) { background: rgba(245, 158, 11, 0.5); }

.combat-btn.special {
    background: rgba(139, 92, 246, 0.3);
    border: 1px solid rgba(139, 92, 246, 0.5);
    color: #a78bfa;
}

.combat-btn.special:hover:not(:disabled) { background: rgba(139, 92, 246, 0.5); }

.combat-btn:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-icon { font-size: 18px; }
.btn-text { flex: 1; text-align: left; font-weight: 600; font-size: 12px; }
.btn-damage { font-size: 10px; opacity: 0.8; }

.no-target {
    padding: 20px;
    text-align: center;
    color: rgba(200, 212, 232, 0.5);
    font-size: 12px;
}

/* Battle Odds */
.battle-odds {
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid rgba(239, 68, 68, 0.2);
}

.odds-bar {
    display: flex;
    height: 12px;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 6px;
}

.odds-friendly { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
.odds-enemy { background: linear-gradient(90deg, #dc2626, #ef4444); }

.odds-labels {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
}

.odds-labels .friendly { color: #60a5fa; }
.odds-labels .enemy { color: #f87171; }
</style>

@code {
    private Random _random = new Random(42);
    private string _battleLocation = "Alpha Centauri III";
    private int _battleTurn = 3;
    private bool _autoBattle = false;
    private bool _canRetreat = true;
    private string _currentFormation = "line";
    private int _friendlyPower = 850;
    private int _enemyPower = 720;
    private string _enemyFaction = "ROMULAN FLEET";
    private int _winChance = 62;

    private Guid? _selectedShipId;
    private Guid? _targetShipId;
    private ShipData? _selectedShip;
    private ShipData? _targetShip;

    private List<ShipData> _friendlyShips = new();
    private List<ShipData> _enemyShips = new();
    private List<FormationData> _formations = new();
    private List<BattleLogEntry> _battleLog = new();
    private List<WeaponFire> _weaponFire = new();

    protected override void OnInitialized()
    {
        LoadCombatData();
    }

    private void LoadCombatData()
    {
        _friendlyShips = new List<ShipData>
        {
            new() { Id = Guid.NewGuid(), Name = "USS Enterprise", Class = "Cruiser", Hull = 120, MaxHull = 150, Shield = 80, MaxShield = 100, Attack = 15, HasTorpedoes = true, TorpedoDamage = 25, HasSpecial = true, SpecialAbility = "Saucer Sep", Position = 0 },
            new() { Id = Guid.NewGuid(), Name = "USS Defiant", Class = "Escort", Hull = 60, MaxHull = 75, Shield = 50, MaxShield = 80, Attack = 20, HasTorpedoes = true, TorpedoDamage = 30, HasSpecial = true, SpecialAbility = "Pulse Phaser", Position = 1 },
            new() { Id = Guid.NewGuid(), Name = "USS Voyager", Class = "Cruiser", Hull = 100, MaxHull = 140, Shield = 90, MaxShield = 90, Attack = 12, HasTorpedoes = true, TorpedoDamage = 20, HasSpecial = false, Position = 2 },
            new() { Id = Guid.NewGuid(), Name = "USS Prometheus", Class = "Escort", Hull = 55, MaxHull = 70, Shield = 60, MaxShield = 70, Attack = 18, HasTorpedoes = false, HasSpecial = true, SpecialAbility = "MVAM", Position = 3 }
        };

        _enemyShips = new List<ShipData>
        {
            new() { Id = Guid.NewGuid(), Name = "IRW Valdore", Class = "Cruiser", Hull = 100, MaxHull = 130, Shield = 70, MaxShield = 85, Attack = 14, Position = 0 },
            new() { Id = Guid.NewGuid(), Name = "IRW Khazara", Class = "Cruiser", Hull = 90, MaxHull = 130, Shield = 60, MaxShield = 85, Attack = 14, Position = 1 },
            new() { Id = Guid.NewGuid(), Name = "IRW Terix", Class = "Escort", Hull = 40, MaxHull = 60, Shield = 45, MaxShield = 55, Attack = 16, Position = 2 },
            new() { Id = Guid.NewGuid(), Name = "IRW Haakona", Class = "Battleship", Hull = 180, MaxHull = 200, Shield = 100, MaxShield = 120, Attack = 22, Position = 3, IsDestroyed = false }
        };

        _formations = new List<FormationData>
        {
            new() { Id = "line", Name = "Line", Icon = "‚ïê‚ïê‚ïê", Description = "Balanced formation, all ships engage" },
            new() { Id = "wedge", Name = "Wedge", Icon = "‚ó¢‚ó£", Description = "+20% Attack, -10% Defense" },
            new() { Id = "defensive", Name = "Defensive", Icon = "‚óØ", Description = "+20% Defense, -10% Attack" },
            new() { Id = "spread", Name = "Spread", Icon = "¬∑ ¬∑ ¬∑", Description = "Reduced AoE damage" }
        };

        _battleLog = new List<BattleLogEntry>
        {
            new() { Turn = 1, Message = "Battle commenced at Alpha Centauri III", Type = "" },
            new() { Turn = 1, Message = "USS Enterprise fires phasers at IRW Valdore - 15 damage!", Type = "hit" },
            new() { Turn = 2, Message = "IRW Khazara fires disruptors at USS Voyager - shields absorb 12 damage", Type = "damage" },
            new() { Turn = 2, Message = "USS Defiant fires quantum torpedoes at IRW Terix - 28 damage!", Type = "hit" },
            new() { Turn = 3, Message = "IRW Valdore's shields are failing!", Type = "friendly" }
        };
    }

    private void SelectShip(ShipData ship)
    {
        if (ship.IsDestroyed) return;
        _selectedShipId = ship.Id;
        _selectedShip = ship;
    }

    private void TargetShip(ShipData ship)
    {
        if (ship.IsDestroyed) return;
        _targetShipId = ship.Id;
        _targetShip = ship;
    }

    private (int X, int Y) GetShipPosition(ShipData ship, bool isFriendly)
    {
        int baseX = isFriendly ? -200 : 200;
        int[] yPositions = _currentFormation switch
        {
            "wedge" => new[] { 0, -60, 60, -120 },
            "defensive" => new[] { -40, 40, -80, 80 },
            "spread" => new[] { -100, -30, 30, 100 },
            _ => new[] { -80, -25, 25, 80 }
        };
        
        int xOffset = _currentFormation == "wedge" ? (ship.Position * 30 * (isFriendly ? -1 : 1)) : 0;
        return (baseX + xOffset, yPositions[Math.Min(ship.Position, 3)]);
    }

    private void SetFormation(string formationId)
    {
        _currentFormation = formationId;
        _battleLog.Add(new BattleLogEntry { Turn = _battleTurn, Message = $"Formation changed to {formationId}", Type = "friendly" });
    }

    private int CalculateDamage()
    {
        if (_selectedShip == null) return 0;
        return _selectedShip.Attack + _random.Next(-3, 5);
    }

    private void ExecuteAttack()
    {
        if (_selectedShip == null || _targetShip == null) return;
        
        int damage = CalculateDamage();
        var fromPos = GetShipPosition(_selectedShip, true);
        var toPos = GetShipPosition(_targetShip, false);
        
        _weaponFire.Add(new WeaponFire { FromX = fromPos.X, FromY = fromPos.Y, ToX = toPos.X, ToY = toPos.Y, Color = "#f59e0b" });
        
        if (_targetShip.Shield > 0)
        {
            int shieldDamage = Math.Min(damage, _targetShip.Shield);
            _targetShip.Shield -= shieldDamage;
            damage -= shieldDamage;
        }
        
        if (damage > 0)
        {
            _targetShip.Hull -= damage;
            if (_targetShip.Hull <= 0)
            {
                _targetShip.Hull = 0;
                _targetShip.IsDestroyed = true;
                _battleLog.Add(new BattleLogEntry { Turn = _battleTurn, Message = $"{_targetShip.Name} DESTROYED!", Type = "destroyed" });
                _targetShip = null;
                _targetShipId = null;
            }
        }
        
        _battleLog.Add(new BattleLogEntry { Turn = _battleTurn, Message = $"{_selectedShip.Name} fires at {_targetShip?.Name ?? "target"} - {damage + (_targetShip?.Shield > 0 ? 0 : damage)} damage!", Type = "hit" });
        
        StateHasChanged();
    }

    private void FireTorpedo()
    {
        if (_selectedShip == null || _targetShip == null || !_selectedShip.HasTorpedoes) return;
        
        int damage = _selectedShip.TorpedoDamage;
        _targetShip.Hull -= damage;
        
        _battleLog.Add(new BattleLogEntry { Turn = _battleTurn, Message = $"{_selectedShip.Name} fires torpedoes at {_targetShip.Name} - {damage} hull damage!", Type = "hit" });
        
        if (_targetShip.Hull <= 0)
        {
            _targetShip.Hull = 0;
            _targetShip.IsDestroyed = true;
            _battleLog.Add(new BattleLogEntry { Turn = _battleTurn, Message = $"{_targetShip.Name} DESTROYED!", Type = "destroyed" });
        }
    }

    private void UseSpecial()
    {
        if (_selectedShip?.HasSpecial != true) return;
        Snackbar.Add($"{_selectedShip.Name} activates {_selectedShip.SpecialAbility}!", Severity.Info);
    }

    private void EndPhase()
    {
        _battleTurn++;
        _battleLog.Add(new BattleLogEntry { Turn = _battleTurn, Message = "--- New combat phase ---", Type = "" });
        _weaponFire.Clear();
    }

    private void AttemptRetreat()
    {
        if (_random.Next(100) < 70)
        {
            Snackbar.Add("Fleet is retreating!", Severity.Warning);
            Navigation.NavigateTo("/game/map");
        }
        else
        {
            Snackbar.Add("Retreat failed! Enemy is pursuing!", Severity.Error);
            _canRetreat = false;
        }
    }

    private void ToggleAutoBattle() => _autoBattle = !_autoBattle;

    private string GetShipIcon(string shipClass) => shipClass switch
    {
        "Scout" => "üî≠",
        "Escort" => "‚öîÔ∏è",
        "Cruiser" => "üöÄ",
        "Battleship" => "üí™",
        _ => "üõ∏"
    };

    // Data Classes
    private class ShipData
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public string Class { get; set; } = "";
        public int Hull { get; set; }
        public int MaxHull { get; set; }
        public int Shield { get; set; }
        public int MaxShield { get; set; }
        public int Attack { get; set; }
        public int Position { get; set; }
        public bool IsDestroyed { get; set; }
        public bool HasTorpedoes { get; set; }
        public int TorpedoDamage { get; set; }
        public bool HasSpecial { get; set; }
        public string? SpecialAbility { get; set; }
        
        public int HullPercent => MaxHull > 0 ? (Hull * 100 / MaxHull) : 0;
        public int ShieldPercent => MaxShield > 0 ? (Shield * 100 / MaxShield) : 0;
    }

    private class FormationData
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Icon { get; set; } = "";
        public string Description { get; set; } = "";
    }

    private class BattleLogEntry
    {
        public int Turn { get; set; }
        public string Message { get; set; } = "";
        public string Type { get; set; } = "";
    }

    private class WeaponFire
    {
        public int FromX { get; set; }
        public int FromY { get; set; }
        public int ToX { get; set; }
        public int ToY { get; set; }
        public string Color { get; set; } = "#f59e0b";
    }
}
