@using StarTrekGame.Web.Services
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@implements IDisposable

<div class="notification-bell @(_isOpen ? "open" : "")" @onclick="TogglePanel">
    <span class="bell-icon">ðŸ””</span>
    @if (NotificationService.UnreadCount > 0)
    {
        <span class="unread-badge">@NotificationService.UnreadCount</span>
    }
</div>

@if (_isOpen)
{
    <div class="notification-overlay" @onclick="ClosePanel"></div>
    <div class="notification-panel">
        <div class="panel-header">
            <span>NOTIFICATIONS</span>
            <div class="header-actions">
                @if (NotificationService.Notifications.Any(n => !n.IsRead))
                {
                    <button class="action-btn" @onclick="NotificationService.MarkAllAsRead">Mark All Read</button>
                }
                <button class="close-btn" @onclick="ClosePanel">âœ•</button>
            </div>
        </div>
        <div class="notification-list">
            @if (NotificationService.Notifications.Any())
            {
                @foreach (var notification in NotificationService.Notifications.Take(20))
                {
                    <div class="notification-item @(notification.IsRead ? "read" : "unread")" 
                         style="border-left-color: @notification.TypeColor;"
                         @onclick="() => HandleNotificationClick(notification)">
                        <span class="notification-icon">@notification.TypeIcon</span>
                        <div class="notification-content">
                            <span class="notification-title">@notification.Title</span>
                            <span class="notification-message">@notification.Message</span>
                            <span class="notification-time">@FormatTime(notification.Timestamp)</span>
                        </div>
                        <button class="dismiss-btn" @onclick="() => NotificationService.Dismiss(notification.Id)" @onclick:stopPropagation="true">âœ•</button>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <span class="empty-icon">ðŸ“­</span>
                    <span>No notifications</span>
                </div>
            }
        </div>
    </div>
}

<style>
    .notification-bell {
        position: relative;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.15s;
    }
    .notification-bell:hover, .notification-bell.open {
        background: rgba(255, 255, 255, 0.1);
    }
    .bell-icon { font-size: 20px; }
    .unread-badge {
        position: absolute;
        top: 2px;
        right: 2px;
        min-width: 18px;
        height: 18px;
        background: #ff4455;
        border-radius: 9px;
        font-size: 11px;
        font-weight: 600;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 4px;
    }
    .notification-overlay {
        position: fixed;
        inset: 0;
        background: transparent;
        z-index: 999;
    }
    .notification-panel {
        position: absolute;
        top: 50px;
        right: 0;
        width: 360px;
        max-height: 480px;
        background: rgba(15, 22, 35, 0.98);
        border: 1px solid rgba(60, 90, 130, 0.6);
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.3);
        border-bottom: 1px solid rgba(60, 90, 130, 0.4);
        font-size: 12px;
        font-weight: 600;
        color: #ff9900;
        letter-spacing: 1px;
    }
    .header-actions { display: flex; gap: 8px; align-items: center; }
    .action-btn {
        padding: 4px 8px;
        background: transparent;
        border: 1px solid rgba(74, 158, 255, 0.5);
        border-radius: 4px;
        color: #4a9eff;
        font-size: 10px;
        cursor: pointer;
    }
    .action-btn:hover { background: rgba(74, 158, 255, 0.2); }
    .close-btn {
        background: transparent;
        border: none;
        color: #7890a8;
        font-size: 16px;
        cursor: pointer;
    }
    .notification-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
    }
    .notification-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 10px 12px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        margin-bottom: 6px;
        border-left: 3px solid #4a9eff;
        cursor: pointer;
        transition: all 0.15s;
    }
    .notification-item:hover { background: rgba(74, 158, 255, 0.1); }
    .notification-item.read { opacity: 0.6; }
    .notification-item.unread { background: rgba(74, 158, 255, 0.05); }
    .notification-icon { font-size: 18px; }
    .notification-content { flex: 1; min-width: 0; }
    .notification-title { display: block; font-size: 12px; font-weight: 600; color: #c8d4e8; margin-bottom: 2px; }
    .notification-message { display: block; font-size: 11px; color: #7890a8; line-height: 1.4; }
    .notification-time { display: block; font-size: 9px; color: #506070; margin-top: 4px; }
    .dismiss-btn {
        background: transparent;
        border: none;
        color: #506070;
        font-size: 12px;
        cursor: pointer;
        padding: 4px;
        opacity: 0;
        transition: opacity 0.15s;
    }
    .notification-item:hover .dismiss-btn { opacity: 1; }
    .dismiss-btn:hover { color: #ff4455; }
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #506070;
    }
    .empty-icon { font-size: 32px; margin-bottom: 8px; }
</style>

@code {
    private bool _isOpen = false;

    protected override void OnInitialized()
    {
        NotificationService.OnNotificationsChanged += StateHasChanged;
    }

    private void TogglePanel()
    {
        _isOpen = !_isOpen;
    }

    private void ClosePanel()
    {
        _isOpen = false;
    }

    private void HandleNotificationClick(GameNotification notification)
    {
        NotificationService.MarkAsRead(notification.Id);
        
        if (!string.IsNullOrEmpty(notification.ActionUrl))
        {
            Navigation.NavigateTo(notification.ActionUrl);
            ClosePanel();
        }
    }

    private string FormatTime(DateTime timestamp)
    {
        var diff = DateTime.UtcNow - timestamp;
        if (diff.TotalMinutes < 1) return "Just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        return timestamp.ToLocalTime().ToString("MMM d");
    }

    public void Dispose()
    {
        NotificationService.OnNotificationsChanged -= StateHasChanged;
    }
}
